<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemAgent - Pharmaceutical Research Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .logo-text span {
            color: var(--primary);
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-input);
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main Container */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Welcome Message */
        .welcome {
            text-align: center;
            padding: 3rem 1rem;
        }
        
        .welcome h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .welcome p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        .example-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .example-query {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .example-query:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .example-query .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .example-query .title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .example-query .text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .message.user .avatar {
            background: var(--primary);
        }
        
        .message.assistant .avatar {
            background: var(--secondary);
        }
        
        .message-content {
            max-width: 85%;
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            overflow: hidden;
        }
        
        .message.user .message-content {
            background: var(--primary);
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.assistant .message-content {
            border-bottom-left-radius: 0.25rem;
            max-width: 90%;
        }
        
        /* Progress Indicator */
        .progress-container {
            background: var(--bg-input);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.75rem;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .progress-bar {
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.8125rem;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }
        
        .progress-step.active {
            color: var(--text-primary);
        }
        
        .progress-step.completed {
            color: var(--success);
        }
        
        .step-icon {
            width: 18px;
            text-align: center;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--text-secondary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Result Display */
        .result-content {
            margin-top: 1rem;
        }
        
        .result-content h4 {
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .compound-card {
            background: var(--bg-input);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .compound-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .compound-id {
            color: var(--primary);
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .property {
            background: var(--bg-dark);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
        }
        
        .property-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.125rem;
        }
        
        .property-value {
            font-weight: 600;
            font-family: monospace;
        }
        
        /* Input Area */
        .input-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.75rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .input-container:focus-within {
            border-color: var(--primary);
        }
        
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            outline: none;
        }
        
        textarea::placeholder {
            color: var(--text-secondary);
        }
        
        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .send-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Markdown Content Styles */
        .markdown-content {
            overflow-x: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .markdown-content th,
        .markdown-content td {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            text-align: left;
        }
        
        .markdown-content th {
            background: var(--bg-input);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .markdown-content td {
            white-space: normal;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .markdown-content img {
            max-width: 200px;
            height: auto;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }
        
        .markdown-content h2 {
            font-size: 1.25rem;
        }
        
        .markdown-content h3 {
            font-size: 1.1rem;
        }
        
        .markdown-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content ul, 
        .markdown-content ol {
            margin: 0.5rem 0 0.5rem 1.5rem;
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
        }
        
        .markdown-content code {
            background: var(--bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
        }
        
        .markdown-content pre {
            background: var(--bg-input);
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }
        
        footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 0.75rem 1rem;
            }
            
            .logo {
                font-size: 1.25rem;
            }
            
            main {
                padding: 1rem;
            }
            
            .welcome h1 {
                font-size: 1.5rem;
            }
            
            .example-queries {
                grid-template-columns: 1fr;
            }
            
            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">üß™</span>
            <span class="logo-text">Chem<span>Agent</span></span>
        </div>
        <div class="header-actions">
            <div class="status-badge">
                <span class="status-dot"></span>
                <span id="status-text">Connected</span>
            </div>
        </div>
    </header>
    
    <main>
        <div class="chat-container" id="chat-container">
            <div class="welcome" id="welcome">
                <h1>üß¨ Welcome to ChemAgent</h1>
                <p>Your AI-powered pharmaceutical research assistant. Ask questions about compounds, targets, properties, and more.</p>
                
                <div class="example-queries">
                    <div class="example-query" onclick="submitExample('What is aspirin?')">
                        <div class="icon">üíä</div>
                        <div class="title">Compound Lookup</div>
                        <div class="text">What is aspirin?</div>
                    </div>
                    <div class="example-query" onclick="submitExample('Calculate molecular properties of CC(=O)Oc1ccccc1C(=O)O')">
                        <div class="icon">‚öóÔ∏è</div>
                        <div class="title">Property Calculation</div>
                        <div class="text">Calculate properties from SMILES</div>
                    </div>
                    <div class="example-query" onclick="submitExample('Find compounds similar to ibuprofen')">
                        <div class="icon">üî¨</div>
                        <div class="title">Similarity Search</div>
                        <div class="text">Find similar compounds</div>
                    </div>
                    <div class="example-query" onclick="submitExample('Find targets for CHEMBL25')">
                        <div class="icon">üéØ</div>
                        <div class="title">Target Discovery</div>
                        <div class="text">Find drug targets</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <textarea 
                id="query-input" 
                placeholder="Ask about compounds, properties, targets, or similarity searches..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button class="send-btn" id="send-btn" onclick="submitQuery()">
                <span>Send</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                </svg>
            </button>
        </div>
    </main>
    
    <footer>
        <p>ChemAgent API v1.0.0 ‚Ä¢ <a href="/docs" target="_blank">API Documentation</a> ‚Ä¢ <a href="/health" target="_blank">Health Check</a></p>
    </footer>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const queryInput = document.getElementById('query-input');
        const sendBtn = document.getElementById('send-btn');
        const welcome = document.getElementById('welcome');
        
        let isProcessing = false;
        
        // Session management for conversation memory
        let sessionId = sessionStorage.getItem('chemagent_session') || null;
        
        function getOrCreateSession() {
            if (!sessionId) {
                sessionId = 'session_' + Math.random().toString(36).substring(2, 10);
                sessionStorage.setItem('chemagent_session', sessionId);
            }
            return sessionId;
        }
        
        function clearSession() {
            sessionId = null;
            sessionStorage.removeItem('chemagent_session');
            // Get a new session
            getOrCreateSession();
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitQuery();
            }
        }
        
        function submitExample(query) {
            queryInput.value = query;
            autoResize(queryInput);
            submitQuery();
        }
        
        async function submitQuery() {
            const query = queryInput.value.trim();
            if (!query || isProcessing) return;
            
            isProcessing = true;
            sendBtn.disabled = true;
            welcome.style.display = 'none';
            
            // Add user message
            addMessage('user', query);
            queryInput.value = '';
            autoResize(queryInput);
            
            // Add assistant message with progress
            const messageEl = addMessage('assistant', '', true);
            const contentEl = messageEl.querySelector('.message-content');
            
            try {
                // Use fetch with streaming
                const response = await fetch('/query/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query, 
                        verbose: true,
                        session_id: getOrCreateSession()
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let progressEl = null;
                let stepsInfo = { total: 0, current: 0, steps: [] };
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            handleStreamEvent(data, contentEl, stepsInfo);
                        }
                    }
                }
            } catch (error) {
                contentEl.innerHTML = `<div style="color: var(--error);">‚ùå Error: ${error.message}</div>`;
            }
            
            isProcessing = false;
            sendBtn.disabled = false;
            queryInput.focus();
            scrollToBottom();
        }
        
        function handleStreamEvent(data, contentEl, stepsInfo) {
            switch (data.status) {
                case 'parsing':
                    contentEl.innerHTML = createProgressHTML('Understanding your question...', 0, [
                        { status: 'active', text: 'Parsing query...' }
                    ]);
                    break;
                    
                case 'parsed':
                    contentEl.innerHTML = createProgressHTML(`Identified: ${data.intent}`, 15, [
                        { status: 'completed', text: `Intent: ${data.intent}` },
                        { status: 'active', text: 'Planning execution...' }
                    ]);
                    break;
                    
                case 'planning':
                    contentEl.innerHTML = createProgressHTML('Creating execution plan...', 20, [
                        { status: 'completed', text: 'Query parsed' },
                        { status: 'active', text: 'Planning execution...' }
                    ]);
                    break;
                    
                case 'planned':
                    stepsInfo.total = data.steps;
                    stepsInfo.steps = data.step_descriptions || [];
                    const planSteps = [
                        { status: 'completed', text: 'Query parsed' },
                        { status: 'completed', text: `Plan ready: ${data.steps} steps` }
                    ];
                    stepsInfo.steps.forEach((desc, i) => {
                        planSteps.push({ status: 'pending', text: desc });
                    });
                    contentEl.innerHTML = createProgressHTML(`Executing ${data.steps} steps...`, 25, planSteps);
                    break;
                    
                case 'executing':
                    stepsInfo.current = data.step;
                    const progress = 25 + (data.step / stepsInfo.total) * 65;
                    const execSteps = [
                        { status: 'completed', text: 'Query parsed' },
                        { status: 'completed', text: `Plan ready: ${stepsInfo.total} steps` }
                    ];
                    stepsInfo.steps.forEach((desc, i) => {
                        if (i < data.step - 1) {
                            execSteps.push({ status: 'completed', text: desc });
                        } else if (i === data.step - 1) {
                            execSteps.push({ status: 'active', text: data.tool_description || desc });
                        } else {
                            execSteps.push({ status: 'pending', text: desc });
                        }
                    });
                    contentEl.innerHTML = createProgressHTML(
                        `Step ${data.step}/${data.total_steps}: ${data.tool_description}`,
                        progress,
                        execSteps
                    );
                    break;
                    
                case 'step_complete':
                    // Update happens on next 'executing' event
                    break;
                    
                case 'complete':
                    contentEl.innerHTML = formatResult(data);
                    break;
                    
                case 'error':
                    contentEl.innerHTML = `<div style="color: var(--error);">‚ùå Error: ${data.error}</div>`;
                    break;
            }
            scrollToBottom();
        }
        
        function createProgressHTML(message, percent, steps) {
            const stepsHTML = steps.map(s => {
                let icon = '‚óã';
                if (s.status === 'completed') icon = '‚úì';
                else if (s.status === 'active') icon = '<span class="spinner"></span>';
                return `<div class="progress-step ${s.status}">
                    <span class="step-icon">${icon}</span>
                    <span>${s.text}</span>
                </div>`;
            }).join('');
            
            return `
                <div class="progress-container">
                    <div class="progress-header">
                        <span>${message}</span>
                        <span>${Math.round(percent)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="progress-steps">${stepsHTML}</div>
                </div>
            `;
        }
        
        function formatResult(data) {
            if (!data.success) {
                return `<div style="color: var(--error);">‚ùå ${data.error || 'Query failed'}</div>`;
            }
            
            const result = data.result;
            if (!result) {
                return '<div>‚úÖ Query completed successfully but returned no data.</div>';
            }
            
            // Get the raw_data if available, otherwise use result directly
            const rawData = result.raw_data || result;
            
            let html = '<div class="result-content">';
            
            // PRIORITY: If there's a synthesized answer from the agent, show that first
            // The answer is the LLM-generated human-readable response
            if (result.answer && typeof result.answer === 'string' && result.answer.length > 50) {
                // Use the formatted markdown answer from OptimalAgent
                const parseMarkdown = typeof marked !== 'undefined' ? marked.parse : (text) => text.replace(/\n/g, '<br>');
                html += `<div class="markdown-content">${parseMarkdown(result.answer)}</div>`;
            } else {
                // Fallback: Format raw data directly
                // Check if this is OptimalAgent response with tool results
                let extractedData = rawData;
                if (rawData && typeof rawData === 'object') {
                    // Check for agent tool result format: { "tool_name": { "success": true, "data": {...} } }
                    const toolNames = ['rdkit_calc_properties', 'chembl_search_by_name', 'chembl_get_activities', 'chembl_get_compound'];
                    for (const toolName of toolNames) {
                        if (rawData[toolName] && rawData[toolName].data) {
                            extractedData = rawData[toolName].data;
                            break;
                        }
                    }
                }
                
                // Format based on result type
                if (extractedData.compound && extractedData.activities) {
                    html += formatCompoundProfile(extractedData);
                } else if (extractedData.compounds && Array.isArray(extractedData.compounds) && extractedData.activities) {
                    html += formatCompoundProfile({
                        compound: extractedData.compounds[0],
                        activities: extractedData.activities
                    });
                } else if (extractedData.compounds && Array.isArray(extractedData.compounds)) {
                    html += formatCompounds(extractedData.compounds);
                } else if (extractedData.similar_compounds && Array.isArray(extractedData.similar_compounds)) {
                    html += formatCompounds(extractedData.similar_compounds);
                } else if (extractedData.activities && Array.isArray(extractedData.activities)) {
                    html += formatActivities(extractedData.activities);
                } else if (extractedData.chembl_id && !extractedData.activities) {
                    html += formatCompound(extractedData);
                } else if (extractedData.properties || extractedData.molecular_weight || extractedData.is_valid !== undefined) {
                    html += formatProperties(extractedData.properties || extractedData);
                } else {
                    // Generic JSON display
                    html += `<pre style="background: var(--bg-input); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.8125rem;">${JSON.stringify(rawData, null, 2)}</pre>`;
                }
            }
            
            html += `<div style="margin-top: 1rem; font-size: 0.8125rem; color: var(--text-secondary);">
                ‚ö° Completed${data.execution_time_ms ? ` in ${Math.round(data.execution_time_ms)}ms` : ''}
            </div>`;
            html += '</div>';
            
            return html;
        }
        
        function formatCompounds(compounds) {
            const limited = compounds.slice(0, 5);
            let html = `<h4>üß™ Found ${compounds.length} compound${compounds.length !== 1 ? 's' : ''}</h4>`;
            
            limited.forEach(c => {
                const compoundId = c.chembl_id || c.molecule_chembl_id || '';
                const displayName = c.name || c.pref_name || compoundId || 'Unknown';
                const similarity = c.similarity ? `<span style="color: var(--secondary);">(${(c.similarity * 100).toFixed(1)}% similar)</span>` : '';
                const structureImg = c.smiles ? `<img src="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(c.smiles)}/PNG?image_size=200x200" alt="Structure" style="max-width: 150px; max-height: 150px; background: white; border-radius: 0.5rem; margin: 0.5rem 0;" onerror="this.style.display='none'">` : '';
                
                html += `
                    <div class="compound-card">
                        <div class="compound-name">${displayName} ${similarity}</div>
                        ${compoundId && compoundId !== displayName ? `<div class="compound-id">${compoundId}</div>` : ''}
                        ${structureImg}
                        ${c.smiles ? `<div style="font-family: monospace; font-size: 0.7rem; color: var(--text-secondary); word-break: break-all;">${c.smiles}</div>` : ''}
                        ${formatPropertiesGrid(c)}
                    </div>
                `;
            });
            
            if (compounds.length > 5) {
                html += `<div style="color: var(--text-secondary); font-size: 0.875rem;">... and ${compounds.length - 5} more</div>`;
            }
            
            return html;
        }
        
        function formatCompound(c) {
            const compoundId = c.chembl_id || c.molecule_chembl_id || '';
            const displayName = c.name || c.pref_name || compoundId || 'Unknown';
            const structureImg = c.smiles ? `<img src="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(c.smiles)}/PNG?image_size=250x250" alt="Structure" style="max-width: 200px; max-height: 200px; background: white; border-radius: 0.5rem; margin: 0.5rem 0;" onerror="this.style.display='none'">` : '';
            return `
                <div class="compound-card">
                    <div class="compound-name">${displayName}</div>
                    ${compoundId && compoundId !== displayName ? `<div class="compound-id">${compoundId}</div>` : ''}
                    ${structureImg}
                    ${c.smiles ? `<div style="font-family: monospace; font-size: 0.7rem; color: var(--text-secondary); word-break: break-all;">${c.smiles}</div>` : ''}
                    ${formatPropertiesGrid(c)}
                </div>
            `;
        }
        
        function formatCompoundProfile(data) {
            // Comprehensive compound profile with structure, properties, and activities
            const c = data.compound || (data.compounds && data.compounds[0]) || {};
            const activities = data.activities || [];
            
            const compoundId = c.chembl_id || c.molecule_chembl_id || '';
            const displayName = c.name || c.pref_name || compoundId || 'Unknown Compound';
            const structureImg = c.smiles ? `<img src="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(c.smiles)}/PNG?image_size=300x300" alt="Structure" style="max-width: 250px; max-height: 250px; background: white; border-radius: 0.5rem; margin: 1rem 0;" onerror="this.style.display='none'">` : '';
            
            // Extract unique targets from activities
            const targetMap = new Map();
            activities.forEach(a => {
                if (a.target_name && a.target_name !== 'Unchecked') {
                    if (!targetMap.has(a.target_name)) {
                        targetMap.set(a.target_name, { name: a.target_name, activities: [] });
                    }
                    targetMap.get(a.target_name).activities.push(a);
                }
            });
            const uniqueTargets = Array.from(targetMap.values()).slice(0, 5);
            
            let html = `
                <div class="compound-profile">
                    <h3 style="margin-bottom: 0.5rem;">üìã ${displayName}</h3>
                    ${compoundId ? `<div class="compound-id" style="margin-bottom: 1rem;">${compoundId}</div>` : ''}
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start;">
                        <div style="flex: 0 0 auto;">
                            ${structureImg}
                            ${c.smiles ? `<div style="font-family: monospace; font-size: 0.7rem; color: var(--text-secondary); word-break: break-all; max-width: 250px;">${c.smiles}</div>` : ''}
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <h4 style="margin-bottom: 0.5rem;">üî¨ Molecular Properties</h4>
                            ${formatPropertiesGrid(c)}
                            
                            ${c.molecular_formula ? `<div style="margin-top: 0.5rem; font-size: 0.875rem;"><strong>Formula:</strong> ${c.molecular_formula}</div>` : ''}
                        </div>
                    </div>
            `;
            
            // Add biological targets section
            if (uniqueTargets.length > 0) {
                html += `
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">üéØ Biological Targets</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${uniqueTargets.map(t => `
                                <div style="background: var(--bg-input); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem;">
                                    <strong>${t.name}</strong>
                                    ${t.activities[0].standard_type ? `<span style="color: var(--text-secondary);"> (${t.activities[0].standard_type}: ${t.activities[0].standard_value || 'N/A'} ${t.activities[0].standard_units || ''})</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Show activities table if available
            if (activities.length > 0) {
                html += `
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">üìä Bioactivity Data (${activities.length} records)</h4>
                        ${formatActivities(activities.slice(0, 5))}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function formatPropertiesGrid(c) {
            const props = [];
            if (c.molecular_weight) props.push({ label: 'MW', value: c.molecular_weight });
            if (c.alogp) props.push({ label: 'ALogP', value: c.alogp });
            if (c.psa) props.push({ label: 'PSA', value: c.psa });
            if (c.hba) props.push({ label: 'HBA', value: c.hba });
            if (c.hbd) props.push({ label: 'HBD', value: c.hbd });
            if (c.ro5_violations !== undefined) props.push({ label: 'RO5', value: c.ro5_violations === 0 ? '‚úì' : c.ro5_violations });
            
            if (props.length === 0) return '';
            
            return `
                <div class="properties-grid">
                    ${props.map(p => `
                        <div class="property">
                            <div class="property-label">${p.label}</div>
                            <div class="property-value">${p.value}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function formatActivities(activities) {
            const limited = activities.slice(0, 10);
            let html = `<h4>Found ${activities.length} bioactivities</h4>`;
            html += '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.8125rem; border-collapse: collapse;">';
            html += '<tr style="color: var(--text-secondary);"><th style="text-align: left; padding: 0.5rem;">Target</th><th style="text-align: left; padding: 0.5rem;">Type</th><th style="text-align: left; padding: 0.5rem;">Value</th></tr>';
            
            limited.forEach(a => {
                html += `<tr style="border-top: 1px solid var(--border);">
                    <td style="padding: 0.5rem;">${a.target_name || a.target_pref_name || 'Unknown'}</td>
                    <td style="padding: 0.5rem;">${a.standard_type || '-'}</td>
                    <td style="padding: 0.5rem;">${a.standard_value ? `${a.standard_value} ${a.standard_units || ''}` : '-'}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            
            if (activities.length > 10) {
                html += `<div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">... and ${activities.length - 10} more</div>`;
            }
            
            return html;
        }
        
        function formatProperties(props) {
            let html = '<h4>üìä Molecular Properties</h4>';
            
            // Show structure if SMILES available
            const smiles = props.smiles || props.canonical_smiles || props.input_smiles;
            if (smiles) {
                html += `<div style="text-align: center; margin: 1rem 0;">
                    <img src="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(smiles)}/PNG?image_size=250x250" 
                         alt="Structure" 
                         style="max-width: 200px; background: white; border-radius: 0.5rem; padding: 0.5rem;"
                         onerror="this.style.display='none'">
                </div>`;
            }
            
            // Key properties to display with nice labels
            const propertyLabels = {
                'molecular_weight': 'Molecular Weight',
                'exact_mass': 'Exact Mass',
                'formula': 'Formula',
                'logp': 'LogP',
                'alogp': 'ALogP',
                'tpsa': 'TPSA',
                'psa': 'PSA',
                'hbd': 'H-Bond Donors',
                'hba': 'H-Bond Acceptors',
                'num_h_donors': 'H-Bond Donors',
                'num_h_acceptors': 'H-Bond Acceptors',
                'rotatable_bonds': 'Rotatable Bonds',
                'num_rotatable_bonds': 'Rotatable Bonds',
                'num_aromatic_rings': 'Aromatic Rings',
                'num_rings': 'Rings',
                'num_heteroatoms': 'Heteroatoms',
                'heavy_atom_count': 'Heavy Atoms',
                'is_valid': 'Valid SMILES',
                'drug_like': 'Drug-like',
                'lipinski_violations': 'Lipinski Violations'
            };
            
            html += '<div class="properties-grid">';
            
            Object.entries(props).forEach(([key, value]) => {
                // Skip internal/display fields
                if (['smiles', 'canonical_smiles', 'input_smiles', 'status', 'inchi', 'inchi_key'].includes(key)) return;
                if (value === null || value === undefined) return;
                
                const label = propertyLabels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let displayValue = value;
                
                // Format numbers nicely
                if (typeof value === 'number') {
                    displayValue = Number.isInteger(value) ? value : value.toFixed(2);
                } else if (typeof value === 'boolean') {
                    displayValue = value ? '‚úÖ Yes' : '‚ùå No';
                }
                
                html += `
                    <div class="property">
                        <div class="property-label">${label}</div>
                        <div class="property-value">${displayValue}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function addMessage(role, content, isLoading = false) {
            const avatar = role === 'user' ? 'üë§' : 'üß™';
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.innerHTML = `
                <div class="avatar">${avatar}</div>
                <div class="message-content">${content || (isLoading ? '<span class="spinner"></span> Thinking...' : '')}</div>
            `;
            chatContainer.appendChild(messageEl);
            scrollToBottom();
            return messageEl;
        }
        
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Check API health on load
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('status-text').textContent = data.status === 'healthy' ? 'Connected' : 'Degraded';
            } catch (e) {
                document.getElementById('status-text').textContent = 'Offline';
                document.querySelector('.status-dot').style.background = 'var(--error)';
            }
        }
        
        checkHealth();
        setInterval(checkHealth, 30000);
        
        // Focus input on load
        queryInput.focus();
    </script>
</body>
</html>
